<!DOCTYPE html>
<html>
	<head>
		<title>TASK Graphs</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<link rel="stylesheet" href="./css/foundation.css">
		<link rel="stylesheet" href="./css/styles.css">
		<link rel="stylesheet" type="text/css" href="./css/wrapper.css">
		<link rel="stylesheet" type="text/css" href="./css/linegraph.css">
	    <script src="./js/underscore.min.js"></script>
		<script src="./js/globals.js"></script>
    	<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
		<script src="./js/pullData.js"></script>
		<script src="./js/wrapper.js"></script>
		<script src="./js/linegraph.js"></script>


		<style>
			body {
			  font: 11px sans-serif;
			}


			.dot {
			  stroke: #000;
			}

			.tooltip {
				position: absolute;
				width: auto;
				height: auto;
				pointer-events: none;
				font-size:15px;
				font-weight: bold;
				font-family: fantasy;
				color: #000;
				background-color: rgba(255,235,153, 0.8);
			  
			}
		</style>
	</head>

	<!-- submenu button space in between divs -->

	<body>
		<!-- banner -->
		<div class="row" id="banner">
			<div class="small-2 small-centered columns" id="bannerID"><img src="./images/banner.png" height="2em"></div>
			<!-- <div class="small-9 small-centered columns">WHEATON ENERGY SAVER</div> -->
		</div>

		<div class="small-9 small-centered columns">
			<div id='cssmenu'>
				<ul>
					<li class='last'><a href='./index.html'><span>Heat Map</span></a></li>
					<li class='last'><a href='#'><span>Consumption Graph</span></a></li>
					<li class='last'><a href='./rankings.html'><span>Rankings</span></a></li>
					<li class='last'><a href='./tips.html'><span>Tips</span></a></li>
					<li class='last'><a href='./calculator.html'><span>Calculator</span></a></li>
				</ul>
			</div>
		</div>

		<div class="row">
			<div class="small-12 small-centered columns container"></div>
		</div>

		<script>
		
		var valStructure= '{"beard" : [],"emerson-dorm" : [],"chapin" : [],"clark" : [],"mcintire" : [],"young" : [],"meadows-ew" : [], "meadows-north" : [],"metcalf" : [],"kilham" : [],"larcom" : [], "stanton": [], "cragin" : [],"everett" : []}';

		var xmlNames= ["beard", "emerson-dorm", "chapin", "clark-mcintire-young", "meadows-ew-1st-floor", "meadows-ew-2nd-floor", "meadows-ew-3rd-floor", "meadows-ew-4th-floor", "meadows-north-1st-floor", "meadows-north-2nd-floor", "meadows-north-3rd-floor", "meadows-north-4th-floor", "metcalf", "kilham", "larcom", "stanton-cragin-everett", "everett-heights"];

		var ewMeadowsDorms=["meadows-ew-2nd-floor", "meadows-ew-3rd-floor"];
		var nMeadowsDorms=["meadows-north-2nd-floor", "meadows-north-3rd-floor", "meadows-north-4th-floor"];

		var allVals=JSON.parse(valStructure);
		var userVals=JSON.parse(valStructure);

		var numHours=998;

		$( document ).ready(function() {
		    
		        for (var i = 0; i <xmlNames.length; i++) {
		            
		            //Following variables for a local file.  Change to path on cs server once the files are correct
		            var name= xmlNames[i];
		            var extension= ".xml"; 
		            var egaugeURL= "./xmlFiles"
		            var slash="/";
		            var tempPath= egaugeURL.concat(slash,name,extension);

		            storeVals(tempPath,name);
		           
		            
		        }

		        //Important: all data processing must wait 1 second for data to be read in. If more than 1 function needed make a function that calls the all necessary functions and call it here in place to toKWH
		        setTimeout(makeGraph,1000);

		});

		function storeVals(path,dorm){

		     var temp=[];

		        //get data and put into array
		        $.ajax({
		        url: path, 
		        dataType: 'xml',
		        async: true,
		        success: function(data){

		            var xml = $('group',data);
		            xml.find("c").each(function() {
		               temp.push(1*($(this).text())); 
		            });

		            //If temp.length > 1000 cannot simply set allVals[dorm]=temp.  Going to need to need some if statements based on the current dorm
		            
		            //Things that get summed: dorm and computer panel, panel 1 and panel 2
		            //Dorms with things to sum: emerson, larcom, meadows ew 1st floor, meadows north 1st floor, stanton
		            //Dorms to separate: ymc, cragin-everett-stanton  
		            //Kilham: Sum 0,1,2,4,6,8
		            //Meadows-ew-4th: sum 0 and 1 skip rest

		            if(temp.length>numHours+1){

		                if (dorm == "clark-mcintire-young"){
		                    for (var i = 0; i < temp.length; i++) {
		                        if (i%3==0){
		                            allVals["clark"].push(temp[i]);
		                        }
		                        else if (i%3==1){
		                            allVals["mcintire"].push(temp[i]);
		                        }
		                        else {
		                            allVals["young"].push(temp[i]);
		                        }
		                    }
		                }

		                else if (dorm == "stanton-cragin-everett"){
		                    var counter=0;
		                    for (var i = 0; i < temp.length; i++) {
		                        if (i%4==0){
		                            allVals["stanton"].push(temp[i]);
		                        }
		                        else if (i%4==1){
		                            allVals["stanton"][counter]+=temp[i];
		                            counter++;
		                        }
		                        else if (i%4==2){
		                            allVals["cragin"].push(temp[i]);
		                        }
		                        else {
		                            allVals["everett"].push(temp[i]);
		                        }
		                    }
		                }

		                else if (dorm == "meadows-ew-1st-floor"){
		                    for (var i = 0; i < temp.length; i+=4) {
		                       allVals["meadows-ew"].push(temp[i]+temp[i+1]+temp[i+2]+temp[i+3]);
		                    }
		                }

		                else if(ewMeadowsDorms.indexOf(dorm) > -1){ 
		                    var counter=0;
		                    for (var i = 0; i < temp.length; i+=2) {
		                       allVals["meadows-ew"][counter]+=(temp[i]+temp[i+1]);
		                       counter++;
		                    }

		                }

		                else if(dorm == "meadows-ew-4th-floor"){ 
		                    var counter=0;
		                    for (var i = 0; i < temp.length; i+=14) {
		                       allVals["meadows-ew"][counter]+=(temp[i]+temp[i+1]);
		                       counter++;
		                    }

		                }
		                
		                else if (dorm == "meadows-north-1st-floor"){
		                    for (var i = 0; i < temp.length; i+=2) {
		                       allVals["meadows-north"].push(temp[i]+temp[i+1]);
		                    }
		                }

		                else if (dorm == "emerson-dorm"){
		                    for (var i = 0; i < temp.length; i+=2) {
		                       allVals["emerson-dorm"].push(temp[i]+temp[i+1]);
		                    }
		                }

		                else if (dorm == "larcom"){
		                    for (var i = 0; i < temp.length; i+=2) {
		                       allVals["larcom"].push(temp[i]+temp[i+1]);
		                    }
		                }

		                else if (dorm == "kilham"){

		                    for (var i = 0; i < temp.length; i+=10) {
		                       allVals["kilham"].push(temp[i]+temp[i+1]+temp[i+2]+temp[i+4]+temp[i+6]+temp[i+8]);
		                    }                    


		                }

		            }

		            else{
		                
		                if(nMeadowsDorms.indexOf(dorm) > -1){

		                    for (var i = 0; i < temp.length; i++) {
		                           allVals["meadows-north"][i]+=temp[i];
		                    }

		                }

		                else if (dorm == "everett-heights"){
		                    for (var i = 0; i < temp.length; i++) {
		            
		                        allVals["everett"][i]+=temp[i];

		                    }
		                }
		                
		                else{ 
		                    allVals[dorm]=temp;
		                }
		            }
		                   
		        },
		        error: function(data){
		            console.log("Didn't work");
		        }
		        });

		}

		function getValRange(delim,start,end){

		    //For start and end use date.getTime()    


		    var firstVal = 1447889280; //Time of most recent data value
		    var lastVal = firstVal- (3600*numHours); //Currently have 999 rows of data which is 998 hours of data. 3600s in an hr

		    var temp=[];
		    var posStart, posEnd;
		    
		    //Find how many hours after the first data value we have the user start date is.  That is the first postion in array to read from
		    posStart=(start-lastVal)/3600;
		    //Find how many hours before the last data value we have the user end date is.  1000-posEnd is the last position in array to read
		    posEnd= (firstVal-end)/3600;

		    if (delim=='hour'){

		        for (var i = 0; i < _.size(userVals); i++) {
		            
		            var name= _.keys(userVals)[i];

		            for (var j = posStart; j < numHours-posEnd; j++) {

		                    userVals[name].push(allVals[j]);

		            }

		        }

		    }

		    else if (delim=='day'){

		        for (var i = 0; i < _.size(userVals); i++) {
		            
		            var counter=0;
		            var name= _.keys(userVals)[i];

		            for (var j = posStart; j < numHours-posEnd; j++) {
		                //24 hrs in a day so we want every 24th value
		                if(counter%24==0){
		                    userVals[name].push(allVals[j]);
		                }

		                counter++;
		                
		            }

		        }

		    }

		    else if (delim=='week'){

		        for (var i = 0; i < _.size(userVals); i++) {
		            
		            var counter=0;
		            var name= _.keys(userVals)[i];

		            for (var j = posStart; j < numHours-posEnd; j++) {
		                //168 hours in a week so we want every 168 value
		                if(counter%168==0){
		                    userVals[name].push(allVals[j]);
		                }

		                counter++;
		                
		            }

		        }

		    }

		}

		function toKWH(){
		   
		    
		    for (var i = 0; i <_.size(allVals); i++) {
		        var last=allVals[_.keys(allVals)[i]].length -1;
		        for (var j = 0; j < last; j++) {
		            allVals[_.keys(allVals)[i]][j]=((allVals[_.keys(allVals)[i]][j]-allVals[_.keys(allVals)[i]][j+1])/3600000)
		            
		        }
		        //Remove last value as it is not a kwh usage val
		        allVals[_.keys(allVals)[i]].splice(last,1);
		    }

		}

		String.prototype.capFirstLetter = function() {
		    return this.charAt(0).toUpperCase() + this.slice(1);
		}

		function makeGraph() {

		    toKWH();
		   
		    var svgContainer = d3.select(".container").append("svg")
		                         .attr("width", 2000)
		                         .attr("height", 750)
		                         .attr("id", "svgGraph");


		    var transform=50;


		    var colors=["#ff5500", "#B27FB2", "#C8A780", "#FFC0CB", "#106271", "#ff66cc", "#99cc00", "#fff68f", "#7ecdd2", "#ffa500",
		    "#800000", "#008000", "#ff7f50", "#ff4444", "#a0db8e", "#cc6633", "#999966", "#9999ff"];


		    var allDorms= ["beard", "emerson-dorm", "chapin", "clark", "mcintire", "young", "meadows-ew", "meadows-north", "metcalf", "kilham", "larcom", "stanton", "cragin", "everett"];

		    var height=30;
		    var length=200;

		    var tooltip = d3.select("body").append("div")
		                    .attr("class", "tooltip")
		                    .style("opacity", 0);


		    
		    for (n=0; n<allDorms.length; n++){

		        transform=transform+height;
		        var data = allVals[allDorms[n]]; //dormData[n]
		        var max = d3.max(d3.values(data)); //find the max data point NOTE needs to be changed to be an array with all data
		        var scale= height/max; //sets scale so that the max is the full bar
		        var width=600/data.length; //width of each new rect is scaled to number of data points
		        //console.log(width)
		        var d=100; //testing ability to alter the transform based on a variable, useful for when we are looking at multiple dorms
		        var bar = d3.select("svg")
		                    .append("g")
		                    .attr("transform", function() { return "translate("+d+", "+ transform +")"; }); 
		        

		        bar.append("rect")
		           .attr("width", length)
		           .attr("height", height)
		           .attr("fill", "#6495ED")
		           .attr("stroke","black")

		        //Dorm name must be added seperately, because d3   
		        bar.append("text")
		           .attr("dy", height/2)
		           .attr("dx", length/2)
		           .attr("fill", "black")
		           .attr("text-anchor", "middle")
		           .attr("font-weight", "bold")
		           .text(allDorms[n].capFirstLetter());

		        //Draws the full bar

		        bar.append("rect")
		           .attr("x",length)
		           .attr("y",0)
		           .attr("width",603)
		           .attr("height", height)
		           .attr("fill", "#E0FFFF")
		           .attr("stroke", "black")

		        for (j = 0; j < data.length; j++) { 
		            var value=data[j];
		            bar.append("rect")
		               .attr("x",j*width+length+.5)
		               .attr("height", data[j]*scale-2)
		               .attr("y",(height-(data[j]*scale))/2+1)
		               .attr("width",width+2)
		               .attr("fill", colors[n])
		               .attr("id", data[j])
		               .on("mouseover", function() {
		                    tooltip.transition()
		                           .duration(200)
		                           .style("opacity", 1);
		                    tooltip.html("Average power consumed at this moment: " + (this.id*1).toFixed(2)+ " kW/h" + "<br/>" +
		                    "Cost of power at this time " + (this.id*.14).toFixed(2) +" dollars" + "<br/>" +
		                    "C0" + "<sub> 2 </sub>" + " generated by this power " + (this.id*.6379).toFixed(2) + "pounds")

		                           .style("left", (d3.event.pageX + 5) + "px")
		                           .style("top", (d3.event.pageY - 28) + "px");
		                })
		               .on("mouseout", function(d) {
		                   tooltip.transition()
		                          .duration(200)
		                          .style("opacity", 0);
		                });

		            // console.log(data[j]);
		        }  
		    } 
		}

		function echoData(){

		    console.log(allVals);

		}
		 
		    
		</script>

		<!-- loads jquery and foundation -->
		<script src="js/vendor/jquery.min.js"></script>
		<script src="js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>